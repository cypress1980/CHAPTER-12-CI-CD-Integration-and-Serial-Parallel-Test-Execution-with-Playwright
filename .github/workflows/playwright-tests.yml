name: Playwright Tests

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    timeout-minutes: 60
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        shard: [1, 2, 3]
        total_shards: [3]

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v6
      with:
        python-version: '3.12'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest-json-report

    - name: Install Playwright browsers
      run: playwright install --with-deps

    - name: Run sharded tests
      run: |
        pytest tests \
          -n auto \
          --dist=loadgroup \
          --splits ${{ matrix.total_shards }} \
          --group ${{ matrix.shard }} \
          --html=playwright-report/report-${{ matrix.shard }}.html \
          --self-contained-html \
          --json-report \
          --json-report-file=test-results/report-${{ matrix.shard }}.json

    - name: Upload shard artifacts
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: shard-${{ matrix.shard }}
        path: |
          playwright-report/
          test-results/

  aggregate:
    name: Merge Reports
    needs: test
    if: always()
    runs-on: ubuntu-latest

    steps:
    - name: Download all shard artifacts
      uses: actions/download-artifact@v4
      with:
        path: reports

    - name: Build merged Playwright report
      run: |
        python <<'PY'
        import json, glob, os, base64

        json_reports = glob.glob('reports/**/test-results/report-*.json', recursive=True)
        html_reports = glob.glob('reports/**/playwright-report/report-*.html', recursive=True)

        if not json_reports:
            raise SystemExit("No JSON reports found")

        items = []
        total_passed = total_failed = total_skipped = 0

        for jr in sorted(json_reports):
            with open(jr) as f:
                data = json.load(f)

            s = data.get("summary", {})
            passed = s.get("passed", 0)
            failed = s.get("failed", 0)
            skipped = s.get("skipped", 0)

            total_passed += passed
            total_failed += failed
            total_skipped += skipped

            shard = os.path.basename(jr).replace(".json", ".html")
            html_path = next(h for h in html_reports if shard in h)

            with open(html_path, "r", encoding="utf-8") as f:
                encoded = base64.b64encode(f.read().encode()).decode()

            items.append((shard, encoded, passed, failed, skipped))

        out = [
            "<!doctype html>",
            "<html><head><meta charset='utf-8'>",
            "<title>Merged Playwright Report</title>",
            "<style>",
            "body{font-family:Arial;padding:20px}",
            "table{border-collapse:collapse;margin-bottom:20px}",
            "th,td{border:1px solid #ccc;padding:8px}",
            "th{background:#f4f4f4}",
            "iframe{width:100%;height:800px;border:1px solid #ccc}",
            "</style></head><body>",
            "<h1>Merged Playwright Report</h1>",
            f"<p><b>Totals:</b> Passed: {total_passed} | Failed: {total_failed} | Skipped: {total_skipped}</p>",
            "<h2>Shard Summary</h2>",
            "<table><tr><th>Report</th><th>Passed</th><th>Failed</th><th>Skipped</th></tr>"
        ]

        for name, _, p, f, s in items:
            out.append(f"<tr><td>{name}</td><td>{p}</td><td>{f}</td><td>{s}</td></tr>")

        out.append("</table><hr/>")

        for name, encoded, *_ in items:
            out.append(f"<h3>{name}</h3>")
            out.append(
                f"<iframe src='data:text/html;base64,{encoded}'></iframe>"
            )

        out.append("</body></html>")

        with open("merged-playwright-report.html", "w", encoding="utf-8") as f:
            f.write("\n".join(out))

        print("Merged report generated")
        PY

    - name: Upload merged report
      uses: actions/upload-artifact@v4
      with:
        name: playwright-report-merged
        path: merged-playwright-report.html